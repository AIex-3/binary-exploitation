#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <gnu/libc-version.h>

#define SECRETFILE "secret"
#define PASSFILE "pass"

void __attribute__((constructor))print_libc_version(){
	printf("Glibc Version: %s\n", gnu_get_libc_version ());
}


void loadsecret(char *file, char *data, int len) {
	FILE *fp;
	fp = fopen(file, "r");
	fgets(data, len, fp);
}

void usage(char *app) {
	printf("Usage: %s username password\n\n", app);
	exit(-1);
}


int main(int argc, char **argv) {

	/* Allocating space on the heap for preventing overwrite of SEIP */
	char *username = malloc(64);
	char *password = malloc(64);
	char *secret = malloc(128);

	/* Checking for arguments */
	if (argc < 3) usage(argv[0]);

	/* Loading password from file */
	loadsecret(PASSFILE, password, 20);
	loadsecret(SECRETFILE, secret, 128);

	/* Dropping privs, so nobody can get root */
	setresuid(getuid(),getuid(),getuid());
	setresgid(getgid(),getgid(),getgid());
		
	strcpy(username, argv[1]);
	
	if ( strncmp(password, argv[2],20) == 0 ) {
		printf("Welcome %s!\n",username);
		printf("The secret data for today is:\n%s\n",secret); 
		/* beeing paranoid and deleting the data from memory */
		free(secret);
	}
}





